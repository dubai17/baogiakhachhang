<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Xuất Kho Bán Hàng</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cấu hình Font và Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Sử dụng font Inter cho toàn bộ tài liệu */
        body { font-family: 'Inter', sans-serif; }
        
        /* ĐỊNH DẠNG CHIỀU RỘNG CỘT CHO PHÙ HỢP (Yêu cầu mở rộng Tên hàng, thu gọn các cột số) */
        .stt-col { width: 5%; }
        .name-col { width: 45%; } /* Mở rộng cho Tên hàng */
        .unit-col { width: 10%; } /* Thu gọn Đơn vị */
        .qty-col { width: 10%; } /* Thu gọn Số lượng */
        .price-col { width: 15%; } /* Thu gọn Đơn giá */
        .total-col { width: 15%; } /* Giữ nguyên Thành tiền */

        /* Tùy chỉnh input để trông giống text */
        .editable-input, .editable-textarea {
            outline: none;
            border: none; /* Bỏ border mặc định */
            padding: 0;
            background: transparent;
            width: 100%;
        }
        
        /* Loại bỏ mũi tên spin của input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Style cho các input trong phần tổng kết (Vẫn giữ border-bottom cho dễ phân biệt) */
        .table-input {
            text-align: right;
            /* Giữ border-bottom cho các input tài chính (VAT, Cọc) */
            border-bottom: 1px solid #e5e7eb; 
        }

        /* Loại bỏ gạch dưới cho input trong bảng chi tiết (Sản phẩm, Đơn vị, Số lượng, Đơn giá) */
        .item-input-no-border {
             border-bottom: none !important;
        }

        .table-cell {
            padding: 8px 12px;
            border-right: 1px solid #e5e7eb;
        }

        /* Giao diện cho chế độ không chỉnh sửa (read-only) */
        .cursor-default { cursor: default; }
        .opacity-75 { opacity: 0.75; }
    </style>
</head>
<body class="bg-gray-50 p-2 md:p-8">

    <!-- Đã điều chỉnh max-w-4xl xuống max-w-3xl để khung nhỏ hơn -->
    <div id="invoice-container" class="max-w-3xl mx-auto bg-white shadow-xl rounded-lg p-4 md:p-8">
        
        <!-- HEADER VÀ THÔNG TIN CHUNG -->
        <header class="text-center mb-6 border-b pb-4">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">PHIẾU XUẤT KHO BÁN HÀNG</h1>
            <p class="text-sm text-gray-600 mt-1" id="current-date">Ngày: 28 tháng 10 năm 2025</p>
            <p class="text-sm text-gray-600">Nhân viên bán hàng: 
                <!-- Thêm cursor-default cho trạng thái mặc định read-only -->
                <span class="font-semibold cursor-pointer cursor-default" contenteditable="false" id="salesperson">QUYÊN</span>
            </p>
            <p class="text-sm text-gray-600">SĐT: 
                <!-- Thêm cursor-default cho trạng thái mặc định read-only -->
                <span class="font-semibold cursor-pointer cursor-default" contenteditable="false" id="salesperson-phone">0896581688</span>
            </p>
        </header>

        <!-- THÔNG TIN KHÁCH HÀNG VÀ MÃ PHIẾU -->
        <div class="flex flex-col md:flex-row justify-between mb-6 space-y-4 md:space-y-0">
            <div class="text-sm text-gray-700 w-full md:w-3/5 space-y-1">
                <!-- Thêm thuộc tính disabled cho trạng thái mặc định read-only -->
                <p>Người mua: <input type="text" value="A" id="buyer-name" disabled class="editable-input font-medium border-b border-gray-300 w-4/5 ml-1 opacity-75" placeholder="Tên người mua"></p>
                <p>SĐT: <input type="text" value="B" id="buyer-phone" disabled class="editable-input border-b border-gray-300 w-4/5 ml-1 opacity-75" placeholder="Số điện thoại"></p>
                <p>Địa chỉ: <input type="text" value="C" id="buyer-address" disabled class="editable-input border-b border-gray-300 w-4/5 ml-1 opacity-75" placeholder="Địa chỉ"></p>
                <p>Diễn giải: <input type="text" value="D" id="buyer-note" disabled class="editable-input border-b border-gray-300 w-4/5 ml-1 opacity-75" placeholder="Diễn giải"></p>
            </div>
            <div class="text-right w-full md:w-2/5">
                <p class="text-base md:text-lg font-bold text-gray-800">Số: <span id="pxk-number">PXK...</span></p>
            </div>
        </div>

        <!-- BẢNG CHI TIẾT SẢN PHẨM -->
        <div class="overflow-x-auto shadow-md rounded-lg">
            <table class="min-w-full bg-white border-collapse">
                <thead>
                    <tr class="bg-blue-500 text-white text-xs md:text-sm uppercase tracking-wider">
                        <th class="stt-col table-cell border-b">STT</th>
                        <th class="name-col table-cell border-b text-left">Tên hàng</th>
                        <th class="unit-col table-cell border-b">Đơn vị</th>
                        <th class="qty-col table-cell border-b">Số lượng</th>
                        <th class="price-col table-cell border-b">Đơn giá</th>
                        <th class="total-col table-cell border-b rounded-tr-lg">Thành tiền</th>
                    </tr>
                </thead>
                <tbody id="item-table-body" class="text-gray-700 text-sm">
                    <!-- Dynamic rows will be inserted here (rendered as disabled initially) -->
                </tbody>
            </table>
        </div>
        
        <!-- TỔNG KẾT VÀ TÍNH TOÁN -->
        <div class="flex justify-end mt-4">
            <div class="w-full md:w-2/3 lg:w-1/2 text-right text-sm space-y-2">
                
                <div class="flex justify-between items-center border-t pt-2">
                    <span class="font-semibold text-gray-600">Cộng tiền hàng:</span>
                    <span class="font-semibold text-gray-800" id="subtotal">0</span>
                </div>

                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Tiền thuế GTGT (VND):</span>
                    <!-- Thêm thuộc tính disabled cho trạng thái mặc định read-only -->
                    <input type="number" id="vat-tax" value="0" disabled class="editable-input table-input text-gray-800 w-1/2 p-1 focus:bg-gray-100 opacity-75" min="0" oninput="recalculate()">
                </div>
                
                <div class="flex justify-between items-center">
                    <span class="text-gray-600 font-medium">Tiền Khách Đã Chuyển Khoản (Cọc):</span>
                    <!-- Thêm thuộc tính disabled cho trạng thái mặc định read-only -->
                    <input type="number" id="deposit-amount" value="0" disabled class="editable-input table-input text-gray-800 w-1/2 p-1 focus:bg-gray-100 opacity-75" min="0" oninput="recalculate()">
                </div>

                <div class="flex justify-between items-center border-t border-b py-2">
                    <span class="text-base font-bold text-gray-700">Tổng tiền thanh toán (Cần Thu):</span>
                    <span class="text-base font-bold text-red-600" id="total-due">0</span>
                </div>
            </div>
        </div>

        <!-- SỐ TIỀN BẰNG CHỮ VÀ CHỮ KÝ -->
        <div class="mt-6 text-sm">
            <p>Số tiền viết bằng chữ: 
                <!-- Thêm cursor-default cho trạng thái mặc định read-only -->
                <span class="font-medium text-blue-700 cursor-default" id="amount-in-words-display" contenteditable="false"></span>
            </p>
            <p class="mt-4">Số chứng từ gốc kèm theo: 
                <span contenteditable="true" class="border-b border-gray-300 w-4/5 inline-block ml-1">...</span>
            </p>
        </div>

        <!-- CHỮ KÝ -->
        <div class="flex justify-between text-center mt-12 text-sm text-gray-700">
            <div class="w-1/3">
                <p class="font-bold">Người mua hàng</p>
                <p class="italic mt-16">(Ký, họ tên)</p>
            </div>
            <div class="w-1/3">
                <p class="font-bold">Kế toán trưởng</p>
                <p class="italic mt-16">(Ký, họ tên)</p>
            </div>
            <div class="w-1/3">
                <p class="font-bold">Giám đốc</p>
                <p class="italic mt-16">(Ký, họ tên)</p>
            </div>
        </div>
    </div>
    
    <!-- KHỐI CHỨC NĂNG (Nằm ngoài vùng in) -->
    <div class="flex justify-center mt-6 space-x-4 print:hidden">
        
        <!-- Buttons for editing (hidden initially) -->
        <button id="add-row-btn" onclick="addRow()" class="flex items-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition duration-150 hidden">
            <!-- Icon + -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
            + Thêm Sản Phẩm
        </button>
        <button id="remove-row-btn" onclick="removeLastRow()" class="flex items-center bg-red-400 hover:bg-red-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition duration-150 hidden">
            <!-- Icon - -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
            - Xóa Dòng Cuối Cùng
        </button>
        
        <!-- Button to toggle edit mode -->
        <button id="toggle-edit-btn" onclick="toggleEditMode()" class="flex items-center bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition duration-150">
            <!-- Initial icon: Edit (vì là nút Bật chế độ sửa) -->
            <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-1.414 10.414L3 16.5V13.5l8.586-8.586 2.828 2.828z" />
            </svg>
            Sửa PXK
        </button>
        
        <!-- Print button (hidden initially, visible in view mode) -->
        <button id="print-btn" onclick="window.print()" class="flex items-center bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition duration-150 hidden">
            <!-- Icon Print -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm4 2a1 1 0 00-1 1v2a1 1 0 102 0V7a1 1 0 00-1-1zm8 5H3a1 1 0 01-1-1V8a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1z" clip-rule="evenodd" /></svg>
            In Phiếu
        </button>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA STATE ---
        // Giảm số dòng mặc định xuống 5
        let items = [
            { name: 'Pha cốc ánh sáng vàng 500W', unit: 'Cái', quantity: 2, unitPrice: 950000 },
            { name: '', unit: '', quantity: 0, unitPrice: 0 },
            { name: '', unit: '', quantity: 0, unitPrice: 0 },
            { name: '', unit: '', quantity: 0, unitPrice: 0 },
            { name: '', unit: '', quantity: 0, unitPrice: 0 }
        ];
        
        let isEditable = false; // Trạng thái mặc định: KHÔNG chỉnh sửa

        const TABLE_BODY_ID = 'item-table-body';
        const PXK_NUMBER_ID = 'pxk-number';
        const SUB_TOTAL_ID = 'subtotal';
        const TOTAL_DUE_ID = 'total-due';
        const AMOUNT_IN_WORDS_ID = 'amount-in-words-display';
        const VAT_TAX_ID = 'vat-tax';
        const DEPOSIT_AMOUNT_ID = 'deposit-amount';
        const CURRENT_DATE_ID = 'current-date';

        // --- HELPER FUNCTIONS ---

        /**
         * Chuyển số sang định dạng tiền tệ Việt Nam (1.000.000)
         * @param {number} amount
         * @returns {string}
         */
        function formatVND(amount) {
            if (typeof amount !== 'number') return '0';
            return amount.toLocaleString('vi-VN');
        }

        /**
         * Chuyển đổi số thành chữ (tiếng Việt) - Logic rút gọn
         * Hỗ trợ đến hàng Tỷ
         * @param {number} num
         * @returns {string}
         */
        function numberToVietnameseWords(num) {
            if (typeof num !== 'number' || num < 0) return 'Không đồng chẵn';
            if (num === 0) return 'Không đồng chẵn';

            const units = ['không', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            const tens = ['', 'mười', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
            const groups = ['', 'nghìn', 'triệu', 'tỷ'];

            function readGroup(group) {
                let s = '';
                const h = Math.floor(group / 100);
                const t = Math.floor((group % 100) / 10);
                const u = group % 10;

                if (h > 0) {
                    s += units[h] + ' trăm ';
                }

                if (t === 1) {
                    s += 'mười ';
                } else if (t > 1) {
                    s += tens[t] + ' ';
                }

                if (u > 0 && t !== 1) {
                    s += units[u];
                } else if (u > 0 && t === 1) {
                    s += (u === 5 ? 'lăm' : units[u]);
                }

                if (t === 0 && u === 0 && h > 0) {
                    s = s.trim(); // Tránh lỗi "trăm không"
                }

                // Xử lý đặc biệt cho 1 và 5
                s = s.replace('một mười', 'mười'); // 10 -> mười
                s = s.replace('mươi năm', 'mươi lăm'); // 25 -> hai mươi lăm
                s = s.replace('mười năm', 'mười lăm'); // 15 -> mười lăm
                s = s.replace('linh một', 'lẻ một'); // 101 -> một trăm lẻ một

                return s.trim();
            }

            let result = '';
            let i = 0;
            let tempNum = num;

            while (tempNum > 0) {
                const group = tempNum % 1000;
                tempNum = Math.floor(tempNum / 1000);

                if (group > 0) {
                    let groupWords = readGroup(group);
                    if (groupWords !== '') {
                        result = groupWords + ' ' + groups[i] + ' ' + result;
                    }
                }
                i++;
            }

            // Capitalize first letter and add currency unit
            result = result.trim();
            if (result.length > 0) {
                result = result.charAt(0).toUpperCase() + result.slice(1);
                result += ' đồng chẵn.';
                result = result.replace(/\s+/g, ' '); // Remove extra spaces
            }

            return result || 'Không đồng chẵn.';
        }


        /**
         * Tạo mã PXK theo format: PXK + DDMMYY + Random A-Z + 4 Random Digits
         * @returns {string}
         */
        function generatePxkNumber() {
            const now = new Date();
            const dd = String(now.getDate()).padStart(2, '0');
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const yy = String(now.getFullYear()).slice(-2);
            
            const randomLetter = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // A-Z
            const randomDigits = String(Math.floor(1000 + Math.random() * 9000)); // 4 digits

            return `PXK${dd}${mm}${yy}${randomLetter}${randomDigits}`;
        }
        
        // --- CORE LOGIC ---
        
        /**
         * Render bảng chi tiết sản phẩm từ mảng items
         */
        function renderTable() {
            const tableBody = document.getElementById(TABLE_BODY_ID);
            if (!tableBody) return;

            tableBody.innerHTML = '';
            
            items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50 transition duration-100';

                // Calculate subtotal for this item
                const subtotal = item.quantity * item.unitPrice;
                
                // Thêm thuộc tính disabled dựa trên isEditable
                const disabledAttr = isEditable ? '' : 'disabled';
                const opacityClass = isEditable ? '' : 'opacity-75';

                row.innerHTML = `
                    <td class="stt-col table-cell text-center font-medium">${index + 1}</td>
                    <td class="name-col table-cell text-left">
                        <input type="text" value="${item.name}" 
                               data-index="${index}" data-field="name" 
                               class="editable-input w-full ${opacityClass}" 
                               onchange="updateItemData(this)" ${disabledAttr}>
                    </td>
                    <td class="unit-col table-cell text-center">
                        <input type="text" value="${item.unit}" 
                               data-index="${index}" data-field="unit" 
                               class="editable-input w-full text-center ${opacityClass}" 
                               onchange="updateItemData(this)" ${disabledAttr}>
                    </td>
                    <td class="qty-col table-cell text-center">
                        <input type="number" value="${item.quantity}" 
                               data-index="${index}" data-field="quantity" 
                               class="editable-input text-center font-medium ${opacityClass}" 
                               min="0" oninput="updateItemData(this)" ${disabledAttr}>
                    </td>
                    <td class="price-col table-cell">
                        <input type="text" value="${formatVND(item.unitPrice)}" 
                               data-index="${index}" data-field="unitPrice" 
                               class="editable-input font-medium text-right ${opacityClass}" 
                               onblur="formatAndRecalc(this)" 
                               onfocus="this.value = this.value.replace(/\\./g, '')" ${disabledAttr}>
                    </td>
                    <td class="total-col table-cell text-right font-bold text-gray-800" data-subtotal="${subtotal}">
                        ${formatVND(subtotal)}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        /**
         * Cập nhật dữ liệu trong mảng items khi có input thay đổi
         * @param {HTMLInputElement} inputElement
         */
        function updateItemData(inputElement) {
            const index = parseInt(inputElement.getAttribute('data-index'));
            const field = inputElement.getAttribute('data-field');
            let value = inputElement.value;

            // Xóa dấu chấm phân cách hàng nghìn cho số
            if (field === 'quantity') {
                value = parseInt(value) || 0;
            } else if (field === 'unitPrice') {
                // Xử lý giá trị number sau khi formatAndRecalc được gọi
                // Tạm thời, giá trị đã được xử lý trong formatAndRecalc
                return; 
            }
            
            items[index][field] = value;
            recalculate();
        }
        
        /**
         * Xử lý format và cập nhật giá trị Đơn giá (Unit Price)
         * @param {HTMLInputElement} inputElement
         */
        function formatAndRecalc(inputElement) {
            const index = parseInt(inputElement.getAttribute('data-index'));
            const field = inputElement.getAttribute('data-field');
            let value = inputElement.value.replace(/\./g, ''); // Xóa dấu chấm
            let numberValue = parseInt(value) || 0;
            
            // Cập nhật giá trị số vào state
            items[index][field] = numberValue;
            
            // Format lại input trên UI
            inputElement.value = formatVND(numberValue);
            
            recalculate();
        }


        /**
         * Tính toán lại toàn bộ tổng kết
         */
        function recalculate() {
            let totalSubtotal = 0;
            
            // 1. Tính Cộng tiền hàng
            items.forEach(item => {
                const subtotal = (parseInt(item.quantity) || 0) * (parseInt(item.unitPrice) || 0);
                totalSubtotal += subtotal;
            });
            
            // 2. Lấy giá trị Thuế và Tiền cọc (Đảm bảo là số)
            const vatTax = parseInt(document.getElementById(VAT_TAX_ID).value.replace(/\./g, '')) || 0;
            const deposit = parseInt(document.getElementById(DEPOSIT_AMOUNT_ID).value.replace(/\./g, '')) || 0;

            // 3. Tính Tổng tiền thanh toán
            const totalMerchandise = totalSubtotal + vatTax;
            const totalDue = totalMerchandise - deposit;
            
            // 4. Cập nhật UI
            document.getElementById(SUB_TOTAL_ID).textContent = formatVND(totalSubtotal);
            document.getElementById(TOTAL_DUE_ID).textContent = formatVND(totalDue);
            
            // Format lại VAT và Deposit để người dùng dễ nhìn
            document.getElementById(VAT_TAX_ID).value = formatVND(vatTax);
            document.getElementById(DEPOSIT_AMOUNT_ID).value = formatVND(deposit);
            
            // Cập nhật Số tiền viết bằng chữ
            document.getElementById(AMOUNT_IN_WORDS_ID).textContent = numberToVietnameseWords(totalDue);

            // Cần render lại bảng để cập nhật cột Thành tiền (Subtotal)
            if (isEditable) {
                renderTable();
            } else {
                // Chỉ cập nhật hiển thị nếu không ở chế độ edit để tránh mất focus
                const totalCells = document.querySelectorAll('[data-subtotal]');
                items.forEach((item, index) => {
                    const subtotal = (parseInt(item.quantity) || 0) * (parseInt(item.unitPrice) || 0);
                    if (totalCells[index]) {
                         totalCells[index].textContent = formatVND(subtotal);
                    }
                });
            }
        }

        /**
         * Bật/tắt chế độ chỉnh sửa (Sửa PXK)
         */
        function toggleEditMode() {
            isEditable = !isEditable;
            
            // Cập nhật trạng thái các nút chức năng
            const btnAdd = document.getElementById('add-row-btn');
            const btnRemove = document.getElementById('remove-row-btn');
            const btnPrint = document.getElementById('print-btn');
            const btnToggle = document.getElementById('toggle-edit-btn');
            const iconToggle = document.getElementById('toggle-icon');
            
            if (isEditable) {
                // Vào chế độ chỉnh sửa
                btnAdd.classList.remove('hidden');
                btnRemove.classList.remove('hidden');
                btnPrint.classList.add('hidden');
                btnToggle.textContent = 'Khóa PXK';
                btnToggle.classList.remove('bg-gray-700');
                btnToggle.classList.add('bg-orange-500');
                
                // Đổi icon sang Lock
                iconToggle.innerHTML = '<path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />';
                
                console.log("Đã bật chế độ chỉnh sửa.");
            } else {
                // Ra khỏi chế độ chỉnh sửa (chế độ xem/in)
                btnAdd.classList.add('hidden');
                btnRemove.classList.add('hidden');
                btnPrint.classList.remove('hidden');
                btnToggle.textContent = 'Sửa PXK';
                btnToggle.classList.remove('bg-orange-500');
                btnToggle.classList.add('bg-gray-700');
                
                // Đổi icon sang Edit
                iconToggle.innerHTML = '<path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-1.414 10.414L3 16.5V13.5l8.586-8.586 2.828 2.828z" />';
                
                console.log("Đã khóa chế độ chỉnh sửa.");
            }
            
            // Cập nhật trạng thái input của toàn bộ phiếu
            updateFormEditability();
        }

        /**
         * Cập nhật trạng thái editable/disabled cho toàn bộ form
         */
        function updateFormEditability() {
            // 1. Cập nhật các input trong bảng
            renderTable();

            // 2. Cập nhật các input ngoài bảng (thông tin khách hàng, thuế, cọc)
            const externalInputs = [
                'buyer-name', 'buyer-phone', 'buyer-address', 'buyer-note',
                VAT_TAX_ID, DEPOSIT_AMOUNT_ID
            ];
            externalInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.disabled = !isEditable;
                    if (isEditable) {
                        input.classList.remove('opacity-75');
                    } else {
                        input.classList.add('opacity-75'); // Visual hint for disabled state
                    }
                }
            });

            // 3. Cập nhật các span contenteditable (NV bán hàng, Số tiền bằng chữ)
            const contentEditables = [
                'salesperson', 'salesperson-phone', AMOUNT_IN_WORDS_ID
            ];
            contentEditables.forEach(id => {
                const span = document.getElementById(id);
                if (span) {
                    span.contentEditable = isEditable;
                    if (isEditable) {
                        span.classList.add('border-b', 'border-gray-300', 'hover:border-blue-500');
                        span.classList.remove('cursor-default');
                    } else {
                        span.classList.remove('border-b', 'border-gray-300', 'hover:border-blue-500');
                        span.classList.add('cursor-default');
                    }
                }
            });
            
            // 4. Kích hoạt render lại để đảm bảo mọi thứ đồng bộ
            recalculate();
        }


        /**
         * Thêm một dòng sản phẩm mới vào danh sách
         */
        function addRow() {
            if (!isEditable) return; // Chỉ cho phép khi edit mode
            items.push({ name: '', unit: '', quantity: 0, unitPrice: 0 });
            recalculate();
        }

        /**
         * Xóa dòng cuối cùng trong danh sách
         */
        function removeLastRow() {
            if (!isEditable) return; // Chỉ cho phép khi edit mode
            if (items.length > 1) {
                items.pop();
                recalculate();
            } else {
                console.log('Không thể xóa dòng cuối cùng. Phiếu phải có ít nhất 1 sản phẩm.');
            }
        }
        
        /**
         * Khởi tạo ứng dụng
         */
        function initialize() {
            // 1. Set ngày hiện tại
            const today = new Date();
            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            document.getElementById(CURRENT_DATE_ID).textContent = `Ngày: ${today.toLocaleDateString('vi-VN', options)}`;
            
            // 2. Tạo và hiển thị mã PXK
            document.getElementById(PXK_NUMBER_ID).textContent = generatePxkNumber();
            
            // 3. Set trạng thái ban đầu là read-only và render/tính toán
            isEditable = false;
            updateFormEditability();
        }

        // Bắt đầu ứng dụng khi tài liệu được tải
        window.onload = initialize;

        // Gắn hàm global cho buttons
        window.addRow = addRow;
        window.removeLastRow = removeLastRow;
        window.recalculate = recalculate; // Cần thiết cho oninput/onchange của các trường tổng kết
        window.updateItemData = updateItemData;
        window.formatAndRecalc = formatAndRecalc;
        window.toggleEditMode = toggleEditMode; // Gắn hàm mới
    </script>
</body>
</html>
